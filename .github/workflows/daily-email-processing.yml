name: 📧 Daily Email Processing

on:
  # Run daily at 5 PM UTC (adjust timezone below)
  schedule:
    - cron: '0 17 * * *'  # 5 PM UTC daily
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      max_emails:
        description: 'Maximum number of emails to process'
        required: false
        default: '20'
        type: string

jobs:
  process-emails:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        ref: feature/ai-agent-integration  # Use your agent branch
    
    - name: 🐍 Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: 📦 Install UV package manager
      run: |
        pip install uv
        echo "UV installed successfully"
    
    - name: 🔧 Install dependencies
      run: |
        uv sync
        echo "Dependencies installed successfully"
    
    - name: 📄 Create credentials.json from secret
      run: |
        echo '${{ secrets.GOOGLE_CALENDAR_CREDENTIALS }}' > credentials.json
        echo "Google Calendar credentials file created"
    
    - name: 🤖 Run Email Processing Agent
      run: |
        uv run python main_agent.py --mode agent --max-emails ${{ github.event.inputs.max_emails || '20' }}
      env:
        # Gmail Configuration
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        
        # AI Configuration
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_MODEL: ${{ secrets.AI_MODEL || 'gpt-4' }}
        
        # WhatsApp Configuration (CallMeBot - simpler option)
        WHATSAPP_API_KEY: ${{ secrets.WHATSAPP_API_KEY }}
        WHATSAPP_PHONE: ${{ secrets.WHATSAPP_PHONE }}
        
        # Optional: Twilio WhatsApp (if you prefer)
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
        YOUR_WHATSAPP_NUMBER: ${{ secrets.YOUR_WHATSAPP_NUMBER }}
        
        # Email Filtering
        EMAIL_DOMAIN: ${{ secrets.EMAIL_DOMAIN }}
        
        # Timezone (optional)
        TZ: 'Asia/Singapore'  # Adjust to your timezone
    
    - name: 📊 Upload logs (if failed)
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: email-processor-logs
        path: email_processor.log
        retention-days: 7
